name: Fooocus-CloudPC

on:
  push:
    branches: [ main ]
  workflow_dispatch:   # 手动按钮

jobs:
  draw:
    runs-on: ubuntu-latest   # 官方免费云电脑
    timeout-minutes: 45      # 防止跑死
    permissions:
      contents: write        # 允许 push 图片回仓库

    steps:
      # 1. 拉代码
      - uses: actions/checkout@v4

      # 2. 装 conda（官方脚本最快）
      - name: Install conda
        run: |
          wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh -O miniconda.sh
          bash miniconda.sh -b -p $HOME/conda
          echo "$HOME/conda/bin" >> $GITHUB_PATH

      # 3. 拉 Fooocus + 模型（缓存加速）
      - name: Cache Fooocus
        id: cache-fooocus
        uses: actions/cache@v4
        with:
          path: |
            ~/fooocus
            ~/conda/envs/fooocus
          key: ${{ runner.os }}-fooocus-v2

      - name: Clone & setup Fooocus
        if: steps.cache-fooocus.outputs.cache-hit != 'true'
        run: |
          git clone https://github.com/lllyasviel/Fooocus.git ~/fooocus
          cd ~/fooocus
          conda env create -f environment.yaml -n fooocus
          conda activate fooocus
          python -m pip install -r requirements_versions.txt

      # 4. 生成图片（无显卡，CPU 跑 512×512 约 5 分钟）
      - name: Draw image
        run: |
          source $HOME/conda/etc/profile.d/conda.sh
          conda activate fooocus
          cd ~/fooocus
          python launch.py --prompt "a cute robot, colorful, high quality" \
                           --output-path $GITHUB_WORKSPACE/output.png \
                           --offload \
                           --disable-offload-from-vram \
                           --always-cpu

      # 5. 把图传回仓库 output 分支
      - name: Commit & push image
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout --orphan output || git checkout output
          mv output.png drawing-${{ github.run_number }}.png
          git add .
          git commit -m "drawing ${{ github.run_number }}"
          git push origin output --force
