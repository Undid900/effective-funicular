name: ğŸ–¥ï¸ Windows Cloud PC Deployment

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 9 * * 1-5'  # å·¥ä½œæ—¥æ—©ä¸Š9ç‚¹è‡ªåŠ¨å¯åŠ¨ï¼ˆå¯é€‰ï¼‰

env:
  RDP_PORT: 3389
  WEB_PORT: 8080

jobs:
  deploy-windows-pc:
    name: ğŸš€ éƒ¨ç½² Windows äº‘ç”µè„‘
    runs-on: windows-latest  # ä½¿ç”¨ GitHub æä¾›çš„ Windows è¿è¡Œå™¨
    
    steps:
    - name: ğŸ æ£€æŸ¥ä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”§ é…ç½® Windows è¿œç¨‹æ¡Œé¢ (RDP)
      run: |
        # å¯ç”¨è¿œç¨‹æ¡Œé¢æœåŠ¡
        Enable-NetFirewallRule -DisplayGroup "è¿œç¨‹æ¡Œé¢"
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 1
        
        # è®¾ç½® RDP å¯†ç 
        $securePassword = ConvertTo-SecureString "${{ secrets.RDP_PASSWORD }}" -AsPlainText -Force
        $username = "runneradmin"
        Set-LocalUser -Name $username -Password $securePassword
        
        Write-Output "âœ… RDP æœåŠ¡å·²å¯ç”¨"

    - name: â¬‡ï¸ ä¸‹è½½å¹¶å®‰è£… Cloudflared
      run: |
        $cloudflaredUrl = "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe"
        Invoke-WebRequest -Uri $cloudflaredUrl -OutFile "cloudflared.exe"
        Write-Output "âœ… Cloudflared ä¸‹è½½å®Œæˆ"

    - name: ğŸ“¦ å®‰è£…åŸºç¡€å¼€å‘å·¥å…·
      run: |
        # å®‰è£… Chocolateyï¼ˆWindows åŒ…ç®¡ç†å™¨ï¼‰
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        
        # å®‰è£…å¸¸ç”¨å¼€å‘å·¥å…·
        choco install git -y
        choco install vscode -y
        choco install nodejs -y
        choco install python -y
        choco install googlechrome -y
        
        Write-Output "âœ… åŸºç¡€å¼€å‘å·¥å…·å®‰è£…å®Œæˆ"

    - name: ğŸŒ å¯åŠ¨ Cloudflare Tunnel
      run: |
        # åˆ›å»ºé…ç½®æ–‡ä»¶
        $configContent = @"
tunnel: github-actions-windows
credentials-file: .cloudflared/credentials.json
ingress:
  - hostname: rdp-${{ github.run_id }}.yourdomain.com  # æ›¿æ¢ä¸ºä½ çš„åŸŸå
    service: rdp://localhost:${{ env.RDP_PORT }}
  - hostname: web-${{ github.run_id }}.yourdomain.com  # å¯é€‰ï¼šWeb æœåŠ¡
    service: http://localhost:${{ env.WEB_PORT }}
  - service: http_status:404
"@
        
        New-Item -ItemType Directory -Path ".cloudflared" -Force
        $configContent | Out-File -FilePath ".cloudflared/config.yml" -Encoding UTF8
        
        # å¯åŠ¨éš§é“ï¼ˆåå°è¿è¡Œï¼‰
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel run" -NoNewWindow
        
        Write-Output "ğŸŒ Cloudflare Tunnel å¯åŠ¨æˆåŠŸ"

    - name: ğŸ”„ å¯åŠ¨ç®€æ˜“ Web æœåŠ¡ï¼ˆå¯é€‰ï¼‰
      run: |
        # åˆ›å»ºç®€å•çš„çŠ¶æ€é¡µé¢
        $htmlContent = @"
<!DOCTYPE html>
<html>
<head>
    <title>Windows Cloud PC - Status</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .status { padding: 20px; background: #f0f0f0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ğŸ–¥ï¸ Windows Cloud PC çŠ¶æ€</h1>
    <div class="status">
        <p><strong>è¿è¡ŒID:</strong> ${{ github.run_id }}</p>
        <p><strong>å¯åŠ¨æ—¶é—´:</strong> $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")</p>
        <p><strong>RDP åœ°å€:</strong> rdp-${{ github.run_id }}.yourdomain.com</p>
        <p><strong>ç”¨æˆ·å:</strong> runneradmin</p>
    </div>
</body>
</html>
"@
        $htmlContent | Out-File -FilePath "status.html" -Encoding UTF8
        
        # å¯åŠ¨ç®€æ˜“ HTTP æœåŠ¡å™¨
        Start-Job -ScriptBlock {
            cd $args[0]
            python -m http.server 8080
        } -ArgumentList $PWD.Path
        
        Write-Output "ğŸŒ Web çŠ¶æ€é¡µé¢å·²å¯åŠ¨"

    - name: â° è®¾ç½®è‡ªåŠ¨å…³é—­ï¼ˆ6å°æ—¶ï¼‰
      run: |
        # GitHub Actions æœ€å¤§è¿è¡Œ6å°æ—¶ï¼Œè¿™é‡Œè®¾ç½®5å°æ—¶50åˆ†é’Ÿåè‡ªåŠ¨æ¸…ç†
        $shutdownScript = {
            Start-Sleep 21000  # 5å°æ—¶50åˆ†é’Ÿ
            Write-Output "â° è¿è¡Œæ—¶é—´å³å°†ç»“æŸï¼Œè‡ªåŠ¨å…³é—­ä¸­..."
            exit 0
        }
        Start-Job -ScriptBlock $shutdownScript
        
        Write-Output "â° è‡ªåŠ¨å…³é—­è®¡æ—¶å™¨å·²è®¾ç½®"

    - name: ğŸ“Š æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
      run: |
        Write-Output "ğŸ‰ Windows äº‘ç”µè„‘éƒ¨ç½²å®Œæˆï¼"
        Write-Output "========================================"
        Write-Output "ğŸ”— RDP è¿æ¥ä¿¡æ¯ï¼š"
        Write-Output "   åœ°å€: rdp-${{ github.run_id }}.yourdomain.com"
        Write-Output "   ç”¨æˆ·å: runneradmin"
        Write-Output "   å¯†ç : ***ï¼ˆæŸ¥çœ‹ GitHub Secretsï¼‰"
        Write-Output ""
        Write-Output "ğŸŒ çŠ¶æ€é¡µé¢ï¼š"
        Write-Output "   https://web-${{ github.run_id }}.yourdomain.com"
        Write-Output ""
        Write-Output "â° è‡ªåŠ¨å…³é—­æ—¶é—´: 6å°æ—¶å"
        Write-Output "========================================"

    - name: ğŸ• ä¿æŒè¿è¡Œï¼ˆæœ€å¤§6å°æ—¶ï¼‰
      run: |
        # ä¿æŒè¿è¡Œï¼Œç›´åˆ°è¶…æ—¶æˆ–æ‰‹åŠ¨å–æ¶ˆ
        $startTime = Get-Date
        while ($true) {
            $elapsed = (Get-Date) - $startTime
            $remaining = (6 * 3600) - $elapsed.TotalSeconds
            
            if ($remaining -le 0) {
                Write-Output "â° è¿è¡Œæ—¶é—´ç»“æŸ"
                break
            }
            
            $hours = [math]::Floor
