name: Win-CloudPC

on:
  workflow_dispatch:          # 仅手动触发，防止被 push 误跑
    inputs:
      idle_minutes:
        description: '挂机多少分钟后自动关机(最大360)'
        required: false
        default: '120'

jobs:
  cloud:
    runs-on: windows-latest   # 官方 Windows Server 2022
    timeout-minutes: 360      # 6 小时上限
    steps:
      - name:  Enable GUI & Remote Desktop
        run: |
          # 开启 RDP 并放通防火墙
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          # 新建用户 github / 密码随机 12 位
          $pwd = -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 12 | % {[char]$_})
          net user github $pwd /add
          net localgroup administrators github /add
          # 把登录信息写进 GITHUB_STEP_SUMMARY，控制台可见
          echo "✅ 云电脑已就绪" >> $env:GITHUB_STEP_SUMMARY
          echo "- 地址：$env:COMPUTERNAME.eastus.cloudapp.azure.com" >> $env:GITHUB_STEP_SUMMARY
          echo "- 用户：github" >> $env:GITHUB_STEP_SUMMARY
          echo "- 密码：$pwd" >> $env:GITHUB_STEP_SUMMARY
          # 同时打印到终端，方便调试
          Write-Output "RDP 地址: $env:COMPUTERNAME.eastus.cloudapp.azure.com:3389"
          Write-Output "用户名  : github"
          Write-Output "密  码  : $pwd"

      - name: 安装常用软件 (Chrome + 7z + vscode)
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = 3072
          # 装 Chocolatey
          iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
          # 装软件
          choco install googlechrome 7zip vscode -y

      - name: 挂机保持存活
        run: |
          $idle = ${{ github.event.inputs.idle_minutes }}
          Write-Output "========== 开始挂机，$idle 分钟后自动关机 =========="
          timeout /t ($idle * 60) /nobreak
          Stop-Computer -Force
