name: 优化版Windows临时RDP
on: 
  workflow_dispatch: # 仅手动触发（更安全）
    inputs:
      rdp_duration:
        description: "会话维持时长（分钟，最大300，避免超6小时限制）"
        required: true
        default: "120" # 默认2小时，可手动调整

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ github.event.inputs.rdp_duration }} # 会话时长跟随输入值
    steps:
      - name: 1. 安装基础工具+常用软件（浏览器/编辑器）
        run: |
          # 安装Choco包管理器（Windows常用）
          Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          # 自动安装：Chrome浏览器、VS Code、7-Zip
          choco install googlechrome vscode 7zip -y --no-progress

      - name: 2. 开启RDP服务+防火墙配置
        run: |
          # 开启RDP（注册表修改）
          reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          # 开放3389端口
          netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389 remoteip=any profile=any enable=yes
          # 启动远程桌面服务
          sc config TermService start= auto
          sc start TermService

      - name: 3. 设置管理员密码（从Secrets读取）
        env:
          ADMIN_PWD: ${{ secrets.WINDOWS_RDP_PWD }} # 需提前在仓库Secrets添加
        run: |
          net user administrator $env:ADMIN_PWD /active:yes
          net localgroup administrators administrator /add

      - name: 4. 显示远程连接信息
        run: |
          $ip = (Invoke-WebRequest -Uri "https://api.ipify.org" -UseBasicParsing).Content
          Write-Host "`n=================== 远程连接信息 ===================" -ForegroundColor Green
          Write-Host "📌 远程IP：$ip" -ForegroundColor Cyan
          Write-Host "👤 用户名：administrator" -ForegroundColor Cyan
          Write-Host "🔑 密码：（你设置的 WINDOWS_RDP_PWD）" -ForegroundColor Cyan
          Write-Host "⏱️  有效期：${{ github.event.inputs.rdp_duration }} 分钟" -ForegroundColor Cyan
          Write-Host "====================================================`n" -ForegroundColor Green

      - name: 5. 维持会话
        run: |
          $endTime = (Get-Date).AddMinutes(${{ github.event.inputs.rdp_duration }})
          while ((Get-Date) -lt $endTime) {
            Write-Host "当前时间：$(Get-Date) | 剩余时长：$([math]::Round(($endTime - (Get-Date)).TotalMinutes)) 分钟"
            Start-Sleep -Seconds 60
          }
          Write-Host "会话已到期" -ForegroundColor Red
