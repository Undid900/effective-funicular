name: Deploy Windows Cloud PC with RDP
on:
  workflow_dispatch:
    inputs:
      vm-size:
        description: 'VM Size'
        required: true
        default: 'Standard_D2s_v3'
        type: choice
        options:
        - Standard_B2s
        - Standard_D2s_v3
        - Standard_D4s_v3

env:
  RESOURCE_GROUP: 'github-windows-pc'
  VM_NAME: 'github-win-pc'
  LOCATION: 'eastus'

jobs:
  deploy-windows-vm:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create Resource Group
      run: |
        az group create --name $RESOURCE_GROUP --location $LOCATION

    - name: Deploy Windows VM
      run: |
        az vm create \
          --resource-group $RESOURCE_GROUP \
          --name $VM_NAME \
          --image MicrosoftWindowsDesktop:Windows-11:win11-23h2-pro:latest \
          --size ${{ github.event.inputs.vm-size }} \
          --admin-username githubuser \
          --admin-password "${{ secrets.WINDOWS_PASSWORD }}" \
          --public-ip-address-allocation static \
          --public-ip-sku Standard \
          --nsg-rule RDP

    - name: Get Public IP
      id: ip
      run: |
        PUBLIC_IP=$(az vm show \
          --resource-group $RESOURCE_GROUP \
          --name $VM_NAME \
          --show-details \
          --query publicIps \
          --output tsv)
        echo "::add-mask::$PUBLIC_IP"
        echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT

    - name: Configure RDP and Open Ports
      run: |
        # å¼€å¯ RDP ç«¯å£
        az vm open-port \
          --resource-group $RESOURCE_GROUP \
          --name $VM_NAME \
          --port 3389 \
          --priority 100

    - name: Install Chrome via Azure Run Command
      run: |
        az vm run-command invoke \
          --resource-group $RESOURCE_GROUP \
          --name $VM_NAME \
          --command-id RunPowerShellScript \
          --scripts @scripts/install-chrome.ps1

    - name: Setup RDP Configuration
      run: |
        az vm run-command invoke \
          --resource-group $RESOURCE_GROUP \
          --name $VM_NAME \
          --command-id RunPowerShellScript \
          --scripts @scripts/configure-rdp.ps1

    - name: Display Connection Info
      run: |
        echo "ğŸ¯ Windows Cloud PC éƒ¨ç½²å®Œæˆ!"
        echo "ğŸ“¡ å…¬ç½‘ IP: ${{ steps.ip.outputs.public_ip }}"
        echo "ğŸ‘¤ ç”¨æˆ·å: githubuser"
        echo "ğŸ”‘ å¯†ç : *** (æŸ¥çœ‹ GitHub Secrets)"
        echo "ğŸ–¥ï¸ ä½¿ç”¨ Remote Desktop Connection è¿æ¥"
        echo "mstsc /v:${{ steps.ip.outputs.public_ip }}"

  remote-connection-test:
    needs: deploy-windows-vm
    runs-on: windows-latest
    steps:
    - name: Test RDP Connection
      run: |
        # æµ‹è¯•ç«¯å£è¿é€šæ€§
        $ip = "${{ needs.deploy-windows-vm.outputs.public_ip }}"
        Test-NetConnection -ComputerName $ip -Port 3389
