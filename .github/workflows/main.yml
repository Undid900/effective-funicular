name: ä¼˜åŒ–ç‰ˆWindowsä¸´æ—¶RDP
on: 
  workflow_dispatch: # ä»…æ‰‹åŠ¨è§¦å‘ï¼ˆæ›´å®‰å…¨ï¼‰
    inputs:
      rdp_duration:
        description: "ä¼šè¯ç»´æŒæ—¶é•¿ï¼ˆåˆ†é’Ÿï¼Œæœ€å¤§300ï¼Œé¿å…è¶…6å°æ—¶é™åˆ¶ï¼‰"
        required: true
        default: "120" # é»˜è®¤2å°æ—¶ï¼Œå¯æ‰‹åŠ¨è°ƒæ•´

jobs:
  windows-rdp:
    runs-on: windows-latest
    timeout-minutes: ${{ github.event.inputs.rdp_duration }} # ä¼šè¯æ—¶é•¿è·Ÿéšè¾“å…¥å€¼
    steps:
      - name: 1. å®‰è£…åŸºç¡€å·¥å…·+å¸¸ç”¨è½¯ä»¶ï¼ˆæµè§ˆå™¨/ç¼–è¾‘å™¨ï¼‰
        run: |
          # å®‰è£…ChocoåŒ…ç®¡ç†å™¨ï¼ˆWindowså¸¸ç”¨ï¼‰
          Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          # è‡ªåŠ¨å®‰è£…ï¼šChromeæµè§ˆå™¨ã€VS Codeã€7-Zip
          choco install googlechrome vscode 7zip -y --no-progress

      - name: 2. å¼€å¯RDPæœåŠ¡+é˜²ç«å¢™é…ç½®
        run: |
          # å¼€å¯RDPï¼ˆæ³¨å†Œè¡¨ä¿®æ”¹ï¼‰
          reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          # å¼€æ”¾3389ç«¯å£
          netsh advfirewall firewall add rule name="RDP-3389" dir=in action=allow protocol=TCP localport=3389 remoteip=any profile=any enable=yes
          # å¯åŠ¨è¿œç¨‹æ¡Œé¢æœåŠ¡
          sc config TermService start= auto
          sc start TermService

      - name: 3. è®¾ç½®ç®¡ç†å‘˜å¯†ç ï¼ˆä»Secretsè¯»å–ï¼‰
        env:
          ADMIN_PWD: ${{ secrets.WINDOWS_RDP_PWD }} # éœ€æå‰åœ¨ä»“åº“Secretsæ·»åŠ 
        run: |
          net user administrator $env:ADMIN_PWD /active:yes
          net localgroup administrators administrator /add

      - name: 4. æ˜¾ç¤ºè¿œç¨‹è¿æ¥ä¿¡æ¯
        run: |
          $ip = (Invoke-WebRequest -Uri "https://api.ipify.org" -UseBasicParsing).Content
          Write-Host "`n=================== è¿œç¨‹è¿æ¥ä¿¡æ¯ ===================" -ForegroundColor Green
          Write-Host "ğŸ“Œ è¿œç¨‹IPï¼š$ip" -ForegroundColor Cyan
          Write-Host "ğŸ‘¤ ç”¨æˆ·åï¼šadministrator" -ForegroundColor Cyan
          Write-Host "ğŸ”‘ å¯†ç ï¼šï¼ˆä½ è®¾ç½®çš„ WINDOWS_RDP_PWDï¼‰" -ForegroundColor Cyan
          Write-Host "â±ï¸  æœ‰æ•ˆæœŸï¼š${{ github.event.inputs.rdp_duration }} åˆ†é’Ÿ" -ForegroundColor Cyan
          Write-Host "====================================================`n" -ForegroundColor Green

      - name: 5. ç»´æŒä¼šè¯
        run: |
          $endTime = (Get-Date).AddMinutes(${{ github.event.inputs.rdp_duration }})
          while ((Get-Date) -lt $endTime) {
            Write-Host "å½“å‰æ—¶é—´ï¼š$(Get-Date) | å‰©ä½™æ—¶é•¿ï¼š$([math]::Round(($endTime - (Get-Date)).TotalMinutes)) åˆ†é’Ÿ"
            Start-Sleep -Seconds 60
          }
          Write-Host "ä¼šè¯å·²åˆ°æœŸ" -ForegroundColor Red
